@if (ticket$ | async; as ticket) {
	<div class="ticket-detail-container">
		<div class="ticket-header">
			<div class="flex items-center justify-between mb-6">
				<div class="flex items-center">
					<button class="back-button mr-4" (click)="goBack()">
						<i class="pi pi-arrow-left"></i>
					</button>
					<div>
						<h1 class="ticket-title">{{ ticket.title }}</h1>
						<div class="ticket-meta">
							<span class="ticket-id">#{{ ticket.id.slice(-6).toUpperCase() }}</span>
							<span class="ticket-created">Created {{ formatDate(ticket.createdAt) }}</span>
						</div>
					</div>
				</div>
				<div class="ticket-actions">
					<span class="status-badge"
						[ngClass]="{
							'status-open': ticket.status === TicketStatus.OPEN,
							'status-in-progress': ticket.status === TicketStatus.IN_PROGRESS,
							'status-completed': ticket.status === TicketStatus.COMPLETED
						}">
						{{ getStatusLabel(ticket.status) }}
					</span>
				</div>
			</div>
			<div class="progress-container">
				<div class="progress-bar">
					<div class="progress-step" [class.active]="true" [class.completed]="ticket.status !== TicketStatus.OPEN">
						<div class="step-circle">
							<i class="pi pi-plus"></i>
						</div>
						<span class="step-label">Created</span>
					</div>
					<div class="progress-line" [class.completed]="ticket.status !== TicketStatus.OPEN"></div>
					<div class="progress-step" 
						[class.active]="ticket.status === TicketStatus.IN_PROGRESS || ticket.status === TicketStatus.COMPLETED"
						[class.completed]="ticket.status === TicketStatus.COMPLETED">
						<div class="step-circle">
							<i class="pi pi-cog"></i>
						</div>
						<span class="step-label">In Progress</span>
					</div>
					<div class="progress-line" [class.completed]="ticket.status === TicketStatus.COMPLETED"></div>
					<div class="progress-step" [class.active]="ticket.status === TicketStatus.COMPLETED" [class.completed]="ticket.status === TicketStatus.COMPLETED">
						<div class="step-circle">
							<i class="pi pi-check"></i>
						</div>
						<span class="step-label">Completed</span>
					</div>
				</div>
			</div>
		</div>
		<!-- Main Content -->
		<div class="ticket-content">
			<div class="content-grid">
				<!-- Left Column - Main Details -->
				<div class="main-content">
					<!-- Description Card -->
					<div class="content-card">
						<div class="card-header">
							<h3 class="card-title">
								<i class="pi pi-file-o mr-2"></i>
								Description
							</h3>
						</div>
						<div class="card-content">
							<p class="description-text">{{ ticket.description }}</p>
						</div>
					</div>
					<!-- Timeline Card -->
					<div class="content-card">
						<div class="card-header">
							<h3 class="card-title">
								<i class="pi pi-clock mr-2"></i>
								Timeline
							</h3>
						</div>
						<div class="card-content">
							<div class="timeline">
								<div class="timeline-item">
									<div class="timeline-marker created"></div>
									<div class="timeline-content">
										<div class="timeline-title">Ticket Created</div>
										<div class="timeline-date">{{ formatFullDate(ticket.createdAt) }}</div>
									</div>
								</div>
								@if (ticket.status !== TicketStatus.OPEN) {
									<div class="timeline-item">
										<div class="timeline-marker in-progress"></div>
										<div class="timeline-content">
											<div class="timeline-title">Work Started</div>
											<div class="timeline-date">{{ formatFullDate(ticket.updatedAt) }}</div>
											@if (ticket.assignedTo) {
												<div class="timeline-assignee">Assigned to {{ ticket.assignedTo.name }}</div>
											}
										</div>
									</div>
								}
								@if (ticket.status === TicketStatus.COMPLETED && ticket.completedAt) {
									<div class="timeline-item">
										<div class="timeline-marker completed"></div>
										<div class="timeline-content">
											<div class="timeline-title">Ticket Completed</div>
											<div class="timeline-date">{{ formatFullDate(ticket.completedAt) }}</div>
										</div>
									</div>
								}
							</div>
						</div>
					</div>
				</div>
				<!-- Right Column - Sidebar Info -->
				<div class="sidebar-content">
					<!-- Assignment Card -->
					<div class="content-card">
						<div class="card-header">
							<h3 class="card-title">
								<i class="pi pi-user mr-2"></i>
								Assignment
							</h3>
						</div>
						<div class="card-content">
							@if (ticket.assignedTo) {
								<div class="assignee-info">
									@if (ticket.assignedTo.avatar) {
										<img [src]="ticket.assignedTo.avatar" 
											[alt]="ticket.assignedTo.name"
											class="assignee-avatar">
									} @else {
										<div class="assignee-avatar assignee-initials">
											{{ getInitials(ticket.assignedTo.name) }}
										</div>
									}
									<div class="assignee-details">
										<div class="assignee-name">{{ ticket.assignedTo.name }}</div>
										<div class="assignee-role">{{ ticket.assignedTo.role | titlecase }}</div>
										<div class="assignee-email">{{ ticket.assignedTo.email }}</div>
									</div>
								</div>
							} @else {
								<div class="unassigned-state">
									<div class="unassigned-icon">
										<i class="pi pi-user-plus"></i>
									</div>
									<div class="unassigned-text">
										<div>Not Assigned</div>
										<div class="unassigned-subtitle">Waiting for assignment</div>
									</div>
								</div>
							}
						</div>
					</div>
					<!-- Status Card -->
					<div class="content-card">
						<div class="card-header">
							<h3 class="card-title">
								<i class="pi pi-info-circle mr-2"></i>
								Details
							</h3>
						</div>
						<div class="card-content">
							<div class="detail-row">
								<span class="detail-label">Status</span>
								<span class="detail-value status-value"
									[ngClass]="{
										'text-amber-600': ticket.status === TicketStatus.OPEN,
										'text-blue-600': ticket.status === TicketStatus.IN_PROGRESS,
										'text-emerald-600': ticket.status === TicketStatus.COMPLETED
									}">
									{{ getStatusLabel(ticket.status) }}
								</span>
							</div>
							<div class="detail-row">
								<span class="detail-label">Created</span>
								<span class="detail-value">{{ formatFullDate(ticket.createdAt) }}</span>
							</div>
							<div class="detail-row">
								<span class="detail-label">Last Updated</span>
								<span class="detail-value">{{ formatFullDate(ticket.updatedAt) }}</span>
							</div>
							@if (ticket.completedAt) {
								<div class="detail-row">
									<span class="detail-label">Completed</span>
									<span class="detail-value text-emerald-600">{{ formatFullDate(ticket.completedAt) }}</span>
								</div>
							}
						</div>
					</div>
					<!-- Actions Card -->
					<div class="content-card !overflow-visible">
						<div class="card-header">
							<h3 class="card-title">
								<i class="pi pi-cog mr-2"></i>
								Actions
							</h3>
						</div>
						<div class="card-content">
							<div class="action-buttons">
								<button 
									class="action-btn success"
									(click)="markTicketAsComplete(ticket.id)"
									[disabled]="ticket.status === TicketStatus.COMPLETED"
									[class.opacity-50]="ticket.status === TicketStatus.COMPLETED"
									[class.!cursor-not-allowed]="ticket.status === TicketStatus.COMPLETED"
								>
									<i class="pi pi-check mr-2"></i>
									Mark Complete
								</button>
								
								<div class="relative">
									<button 
										class="action-btn outline !w-full"
										(click)="toggleUserDropdown()"
										[disabled]="ticket.status === TicketStatus.COMPLETED"
										[class.opacity-50]="ticket.status === TicketStatus.COMPLETED"
										[class.!cursor-not-allowed]="ticket.status === TicketStatus.COMPLETED"
									>
										<i class="pi pi-users mr-2"></i>
										Assign User
										<i class="pi pi-chevron-down ml-2"></i>
									</button>
									
									@if (showUserDropdown && ticket.status !== TicketStatus.COMPLETED) {
										<div class="absolute bottom-full left-0 mb-1 w-full bg-white border border-gray-300 rounded-md shadow-lg z-10 min-w-[200px]">
											<div class="py-1 max-h-48 overflow-y-auto">
												@for (user of users; track user.id) {
													<button
														class="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center text-sm"
														(click)="assignUserToTicket(ticket.id, user)"
														[class.bg-blue-50]="ticket.assignedTo?.id === user.id"
													>
														@if (user.avatar) {
															<img [src]="user.avatar" 
																[alt]="user.name"
																class="w-6 h-6 rounded-full mr-2">
														} @else {
															<div class="w-6 h-6 rounded-full bg-gray-400 text-white text-xs flex items-center justify-center mr-2">
																{{ getInitials(user.name) }}
															</div>
														}
														<div class="flex-1">
															<div class="font-medium text-gray-900">{{ user.name }}</div>
															<div class="text-gray-500 text-xs">{{ user.role | titlecase }}</div>
														</div>
														@if (ticket.assignedTo?.id === user.id) {
															<i class="pi pi-check text-blue-600"></i>
														}
													</button>
												} @empty {
													<div class="px-3 py-2 text-gray-500 text-sm">No users available</div>
												}
											</div>
										</div>
									}
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
} @else {
	<div class="loading-container">
		<div class="loading-spinner">
			<i class="pi pi-spin pi-spinner"></i>
		</div>
		<p class="loading-text">Loading ticket details...</p>
	</div>
}
